<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes | My Life Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ range(1, 999999) | random }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="page-notes">
    <nav class="navbar">
        <div class="nav-brand" style="cursor: pointer;" onclick="window.location.href='/';">
            <i class="fas fa-chart-line"></i>
            <span>My Life Tracker</span>
        </div>
        <ul class="nav-links">
            <li><a href="/"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="/habits"><i class="fas fa-fire"></i> Habits</a></li>
            <li><a href="/tasks"><i class="fas fa-list-check"></i> Tasks</a></li>
            <li><a href="/budget"><i class="fas fa-wallet"></i> Budget</a></li>
            <li><a href="/notes" class="active"><i class="fas fa-sticky-note"></i> Notes</a></li>
            <li><a href="/weather"><i class="fas fa-cloud-sun"></i> Weather</a></li>
            <li><a href="/stats"><i class="fas fa-chart-bar"></i> Stats</a></li>
        </ul>
        <div class="theme-toggle-wrapper">
            <div class="theme-toggle" id="themeToggle">
                <span class="theme-toggle-icon moon"><i class="fas fa-moon"></i></span>
                <span class="theme-toggle-icon sun"><i class="fas fa-sun"></i></span>
                <div class="theme-toggle-slider"></div>
            </div>
        </div>
    </nav>

    <section class="dashboard">
        <div class="page-header">
            <h1><i class="fas fa-sticky-note"></i> My Notes</h1>
            <p>Keep your Thoughts and Ideas Organized</p>
        </div>

        <div class="form-card">
            <h2>Create Note</h2>
            <div class="form-group">
                <input type="text" id="noteTitle" placeholder="Note Title" class="input-field">
                <textarea id="noteContent" placeholder="Note Content‚Ä¶" class="input-field" rows="4"></textarea>
                <button onclick="addNote()" class="btn btn-primary"><i class="fas fa-save"></i> Save Note</button>
            </div>
        </div>

        <div class="notes-list" id="notesList" style="margin-top:1.5rem; display:flex; flex-direction:column; gap:1rem;">
            <!-- Notes will be loaded here -->
        </div>
    </section>

    <script>
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        async function loadNotes() {
            const res = await fetch('/api/notes');
            const data = await res.json();
            const container = document.getElementById('notesList');
            container.innerHTML = '';

            const notes = data.notes || [];
            if (notes.length === 0) {
                container.innerHTML = '<p class="empty-state">No notes yet. Create one! üìù</p>';
                return;
            }

            notes.slice().forEach(note => {
                const date = new Date(note.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });
                const noteEl = document.createElement('div');
                noteEl.className = 'transaction-item';
                noteEl.setAttribute('data-note-id', note.id);
                noteEl.innerHTML = `
                    <div class="transaction-info">
                        <h4>${escapeHtml(note.title)}</h4>
                        <p>${escapeHtml(note.content)}</p>
                        <small>${date}</small>
                    </div>
                    <button onclick="deleteNote('${note.id}')" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(noteEl);
            });
        }

        async function addNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            // Only title is required
            if (!title) return;

            const res = await fetch('/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content })
            });

            if (res.ok) {
                const newNote = await res.json();
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                // Append the new note to the end of the list dynamically
                appendNoteToList(newNote);
            }
        }

        async function deleteNote(id) {
            // Remove from UI immediately
            try {
                const el = document.querySelector(`[data-note-id="${id}"]`);
                if (el && el.parentNode) el.parentNode.removeChild(el);
            } catch (e) {}

            // Send delete request to server (no confirmation, no popups)
            try {
                const res = await fetch(`/api/notes/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    // On failure, reload notes to resync state
                    loadNotes();
                }
            } catch (e) {
                console.error('Error deleting note:', e);
                loadNotes();
            }
        }

        // Helper to create a note DOM node and append it to the end
        function appendNoteToList(note) {
            try {
                const container = document.getElementById('notesList');
                // remove empty-state if present
                const empty = container.querySelector('.empty-state');
                if (empty) empty.remove();

                const date = new Date(note.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });
                const noteEl = document.createElement('div');
                noteEl.className = 'transaction-item';
                noteEl.setAttribute('data-note-id', note.id);
                noteEl.innerHTML = `
                    <div class="transaction-info">
                        <h4>${escapeHtml(note.title)}</h4>
                        <p>${escapeHtml(note.content)}</p>
                        <small>${date}</small>
                    </div>
                    <button onclick="deleteNote('${note.id}')" class="btn btn-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(noteEl);
            } catch (e) {
                // fallback: reload entire list
                loadNotes();
            }
        }

        // Initialize theme toggle
        function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            if (!themeToggle) return;
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                themeToggle.classList.add('active');
            }
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('light-theme');
                themeToggle.classList.toggle('active');
                const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
                localStorage.setItem('theme', currentTheme);
            });
        }

        initThemeToggle();
        loadNotes();
    </script>
</body>
</html>